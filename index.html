<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸŒ™ B612 ç¡çœ æ—¥è¨˜</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" type="image/png">
  <meta name="theme-color" content="#3d3d99">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("âœ… Service Worker å·²è¨»å†Š"))
        .catch(err => console.error("âŒ Service Worker è¨»å†Šå¤±æ•—", err));
    }
  </script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(to bottom, #1a1a60, #3d3d99);
      color: white;
      text-align: center;
      padding: 20px;
    }
    h1 {
      font-size: 2em;
      margin-bottom: 0.2em;
    }
    .quote {
      font-style: italic;
      color: #ffd3e0;
      margin-bottom: 20px;
      min-height: 2em;
    }
    button {
      padding: 10px 20px;
      font-size: 1em;
      margin: 10px;
      border-radius: 12px;
      border: none;
      background-color: #ffcc99;
      color: #333;
      cursor: pointer;
    }
    button:hover {
      background-color: #ffe6cc;
    }
    input[type="date"],
    input[type="time"],
    input[type="checkbox"] {
      padding: 6px;
      margin: 5px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
    }
    #log {
      margin-top: 20px;
      white-space: pre-wrap;
      font-size: 1em;
    }
    table {
      margin: 30px auto;
      width: 100%;
      max-width: 600px;
      border-collapse: collapse;
      background-color: white;
      color: #333;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      font-size: 0.95em;
    }
    th {
      background-color: #ffd3e0;
    }
    td[onclick] {
      cursor: pointer;
      text-decoration: underline;
      color: #1a1a60;
    }
    #calendarGrid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    #calendarGrid div {
      padding: 10px;
      background: #fff;
      color: #333;
      border-radius: 8px;
      font-size: 0.9em;
      white-space: pre-line;
    }
    #sleepStats {
      margin-top: 20px;
      font-size: 1em;
      color: #ffd3e0;
      white-space: pre-line;
    }
    @media (max-width: 600px) {
      body {
        padding: 10px;
        font-size: 0.95em;
      }
      table, th, td {
        font-size: 0.85em;
        padding: 6px;
      }
      button {
        font-size: 0.9em;
        padding: 8px 16px;
      }
      #calendarGrid {
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸŒ™ B612 ç¡çœ æ—¥è¨˜</h1>
  <p class="quote" id="quoteDisplay">ğŸ¦Š æ˜Ÿèªè¼‰å…¥ä¸­...</p>

  <button onclick="startSleep()">ğŸª å°ç‹å­å»æ—…è¡Œ</button>
  <button onclick="endSleep()">ğŸŒ ä»–å›åˆ°æ˜Ÿçƒ</button>
  <button onclick="exportAllData()">ğŸ“¦ åŒ¯å‡ºå‚™ä»½ (JSON)</button>
  <input type="file" id="backupFileInput" accept=".json" style="display:none" onchange="handleBackupFile(event)">
  <button onclick="document.getElementById('backupFileInput').click()">ğŸª„ é‚„åŸå‚™ä»½ (JSON)</button>

  <label style="display:block; margin-top:20px;">
    <input type="checkbox" id="autoShiftDate" checked>
    ğŸ•’ å‡Œæ™¨å…¥ç¡æ™‚è‡ªå‹•æç¤ºæ˜¯å¦æ­¸å‰ä¸€å¤©
  </label>

  <div id="log"></div>
  <table>
    <thead>
      <tr>
        <th>ğŸ“… æ—¥æœŸ</th>
        <th>ğŸŒ™ ç¡è¦ºæ™‚é–“</th>
        <th>ğŸŒ èµ·åºŠæ™‚é–“</th>
        <th>ğŸª ç¡çœ æ™‚æ•¸</th>
        <th>ğŸ—‘ åˆªé™¤</th>
      </tr>
    </thead>
    <tbody id="sleepTableBody"></tbody>
  </table>

  <div id="sleepStats"></div>

  <h2 style="margin-top:40px;">ğŸ“š æ­·å²ç¡çœ æ™‚é–“</h2>
  <table>
    <thead>
      <tr>
        <th>ğŸ—‘ åˆªé™¤</th>
        <th>ğŸ“… æ—¥æœŸ</th>
        <th>ğŸŒ™ ç¡è¦ºæ™‚é–“</th>
        <th>ğŸŒ èµ·åºŠæ™‚é–“</th>
        <th>ğŸª ç¡çœ æ™‚æ•¸</th>
      </tr>
    </thead>
    <tbody id="historyTableBody"></tbody>
  </table>
  <button onclick="deleteSelectedHistory()">ğŸ§¹ åˆªé™¤é¸å–ç´€éŒ„</button>
  <button onclick="exportHistoryCSV()">ğŸ“„ åŒ¯å‡ºæ­·å²ç´€éŒ„ (CSV)</button>

  <div id="manualEntry">
    <h2>âœï¸ æ‰‹å‹•æ–°å¢ç¡çœ ç´€éŒ„</h2>
    <input type="date" id="manualDate">
    <input type="time" id="manualSleep">
    <input type="time" id="manualWake">
    <button onclick="addManualRecord()">â• æ–°å¢ç´€éŒ„</button>
  </div>

  <div id="calendar">
    <h2>ğŸ“… æœ¬æœˆç¡çœ ä¸€è¦½</h2>
    <div id="calendarGrid"></div>
  </div>

<script>
let sleepRecords = JSON.parse(localStorage.getItem("sleepRecords") || "[]");
let currentSleepStart = null;

// å˜—è©¦æ¢å¾©è·¨æ—¥ç¡çœ æ™‚é–“
const savedStart = localStorage.getItem("currentSleepStart");
if (savedStart) {
  currentSleepStart = new Date(savedStart);
  log(`ğŸª ç¡è¦ºæ™‚é–“å·²æ¢å¾©ï¼š${formatTime(currentSleepStart)}ï¼ˆæ­¸å±¬æ–¼ ${formatDate(currentSleepStart)}ï¼‰`);
}

function formatDate(date) {
  return date.toISOString().split("T")[0];
}

function formatTime(date) {
  return date.toTimeString().slice(0, 5);
}

function calcDuration(sleep, wake) {
  let diffMs = wake - sleep;
  if (diffMs < 0) diffMs += 24 * 3600000;
  const totalMinutes = Math.round(diffMs / 60000);
  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;
  return `${String(hours).padStart(2, "0")}å°æ™‚${String(minutes).padStart(2, "0")}åˆ†`;
}

function log(msg) {
  document.getElementById("log").textContent = msg;
function saveRecords() {
  localStorage.setItem("sleepRecords", JSON.stringify(sleepRecords));
  renderTable();
  renderStats();
  renderCalendar();
  renderHistoryTable();
}

function startSleep() {
  currentSleepStart = new Date();
  localStorage.setItem("currentSleepStart", currentSleepStart.toISOString());
  log(`ğŸª ç¡è¦ºæ™‚é–“è¨˜éŒ„ç‚º ${formatTime(currentSleepStart)}`);
}

function endSleep() {
  if (!currentSleepStart) {
    alert("è«‹å…ˆè¨˜éŒ„ç¡è¦ºæ™‚é–“ï¼");
    return;
  }
  const wakeTime = new Date();
  const sleepTime = new Date(currentSleepStart);
  const sleepDate = new Date(sleepTime);
  const autoShift = document.getElementById("autoShiftDate").checked;

  if (autoShift && sleepTime.getHours() < 6) {
    sleepDate.setDate(sleepDate.getDate() - 1);
    const confirmShift = confirm("æ˜¯å¦å°‡ç¡çœ æ­¸å±¬æ–¼å‰ä¸€å¤©ï¼Ÿ");
    if (!confirmShift) sleepDate.setDate(sleepDate.getDate() + 1);
  }

  const record = {
    date: formatDate(sleepDate),
    sleep: formatTime(sleepTime),
    wake: formatTime(wakeTime),
    duration: calcDuration(sleepTime, wakeTime)
  };
  sleepRecords.push(record);
  currentSleepStart = null;
  localStorage.removeItem("currentSleepStart");
  saveRecords();
  log(`ğŸŒ èµ·åºŠæ™‚é–“è¨˜éŒ„ç‚º ${formatTime(wakeTime)}ï¼Œå·²å„²å­˜ç´€éŒ„ï¼ˆæ­¸å±¬æ–¼ ${record.date}ï¼‰`);
}

function addManualRecord() {
  const date = document.getElementById("manualDate").value;
  const sleep = document.getElementById("manualSleep").value;
  const wake = document.getElementById("manualWake").value;
  if (!date || !sleep || !wake) {
    alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼");
    return;
  }
  const sleepTime = new Date(`${date}T${sleep}`);
  const wakeTime = new Date(`${date}T${wake}`);
  if (wakeTime < sleepTime) wakeTime.setDate(wakeTime.getDate() + 1);
  sleepRecords.push({
    date,
    sleep,
    wake,
    duration: calcDuration(sleepTime, wakeTime)
  });
  saveRecords();
  log(`âœ… æ‰‹å‹•æ–°å¢ç´€éŒ„ï¼š${date} ${sleep} â†’ ${wake}`);
}

function renderTable() {
  const tbody = document.getElementById("sleepTableBody");
  tbody.innerHTML = "";
  const sorted = [...sleepRecords].sort((a, b) => new Date(b.date) - new Date(a.date));
  sorted.forEach((r, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${r.date}</td>
      <td onclick="editTime(${i}, 'sleep')">${r.sleep}</td>
      <td onclick="editTime(${i}, 'wake')">${r.wake}</td>
      <td>${r.duration}</td>
      <td><button onclick="deleteRecord(${i})">ğŸ—‘</button></td>
    `;
    tbody.appendChild(row);
  });
}

function renderHistoryTable() {
  const tbody = document.getElementById("historyTableBody");
  tbody.innerHTML = "";
  sleepRecords.forEach((r, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><button onclick="deleteRecord(${i})">ğŸ—‘</button></td>
      <td>${r.date}</td>
      <td>${r.sleep}</td>
      <td>${r.wake}</td>
      <td>${r.duration}</td>
    `;
    tbody.appendChild(row);
  });
}
function editTime(index, field) {
  const newTime = prompt(`è«‹è¼¸å…¥æ–°çš„ ${field === "sleep" ? "ç¡è¦º" : "èµ·åºŠ"}æ™‚é–“ (HH:mm)ï¼š`, sleepRecords[index][field]);
  if (newTime && /^\d{2}:\d{2}$/.test(newTime)) {
    sleepRecords[index][field] = newTime;
    const sleep = new Date(`${sleepRecords[index].date}T${sleepRecords[index].sleep}`);
    const wake = new Date(`${sleepRecords[index].date}T${sleepRecords[index].wake}`);
    if (wake < sleep) wake.setDate(wake.getDate() + 1);
    sleepRecords[index].duration = calcDuration(sleep, wake);
    saveRecords();
  }
}

function deleteRecord(index) {
  if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
    sleepRecords.splice(index, 1);
    saveRecords();
  }
}

function deleteSelectedHistory() {
  const confirmDelete = confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼");
  if (confirmDelete) {
    sleepRecords = [];
    saveRecords();
  }
}

function exportHistoryCSV() {
  let csv = "æ—¥æœŸ,ç¡è¦ºæ™‚é–“,èµ·åºŠæ™‚é–“,ç¡çœ æ™‚æ•¸\n";
  sleepRecords.forEach(r => {
    csv += `${r.date},${r.sleep},${r.wake},${r.duration}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "sleep_history.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function exportAllData() {
  const blob = new Blob([JSON.stringify(sleepRecords, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "sleep_backup.json";
  a.click();
  URL.revokeObjectURL(url);
}

function handleBackupFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (Array.isArray(data)) {
        const confirmRestore = confirm("âš ï¸ æ˜¯å¦è¦†è“‹ç¾æœ‰ç´€éŒ„ä¸¦é‚„åŸå‚™ä»½ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼");
        if (confirmRestore) {
          sleepRecords = data;
          saveRecords();
          alert("âœ… å‚™ä»½å·²é‚„åŸï¼");
        }
      } else {
        alert("âŒ æ ¼å¼éŒ¯èª¤ï¼");
      }
    } catch {
      alert("âŒ ç„¡æ³•è§£æå‚™ä»½æª”ï¼");
    }
  };
  reader.readAsText(file);
}

function renderCalendar() {
  const grid = document.getElementById("calendarGrid");
  grid.innerHTML = "";
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  const recordsByDate = {};
  sleepRecords.forEach(r => {
    if (r.date.startsWith(`${year}-${String(month + 1).padStart(2, "0")}`)) {
      recordsByDate[r.date] = r.duration;
    }
  });

  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
    const duration = recordsByDate[dateStr];
    const cell = document.createElement("div");
    cell.textContent = `${d}æ—¥${duration ? `\n${duration}` : ""}`;
    if (duration) {
      const match = duration.match(/(\d+)å°æ™‚(\d+)åˆ†/);
      if (match) {
        const hours = parseInt(match[1], 10);
        cell.style.backgroundColor =
          hours >= 8 ? "#c6f6d5" :
          hours >= 6 ? "#fefcbf" :
          "#feb2b2";
        cell.title = `ç¡çœ å“è³ªï¼š${hours >= 8 ? "å¾ˆå¥½" : hours >= 6 ? "æ™®é€š" : "ä¸ä½³"}`;
      }
    }
    grid.appendChild(cell);
  }
}

const quotes = [
  "ğŸŒŒ æ˜Ÿæ˜Ÿä¹‹æ‰€ä»¥é–ƒçˆï¼Œæ˜¯å› ç‚ºæœ‰äººæ­£åœ¨ä»°æœ›ã€‚",
  "ğŸ¦Š æœ€é‡è¦çš„äº‹ï¼Œç”¨çœ¼ç›æ˜¯çœ‹ä¸è¦‹çš„ã€‚",
  "ğŸŒ™ ç¡çœ æ˜¯éˆé­‚çš„æŸ”è»Ÿæ£‰è¢«ã€‚",
  "ğŸª å°ç‹å­èªªï¼šã€è«‹å¥½å¥½ç…§é¡§ä½ çš„æ˜Ÿçƒã€‚ã€",
  "ğŸ’¤ ä½ å€¼å¾—ä¸€å ´æ·±æ²‰è€Œæº«æŸ”çš„ç¡çœ ã€‚",
  "ğŸŒ  æ¯å€‹å¤œæ™šï¼Œéƒ½æ˜¯å¿ƒéˆçš„é‡å•Ÿå„€å¼ã€‚",
  "ğŸ§¸ ç¡å‰çš„å®‰éœï¼Œæ˜¯çµ¦è‡ªå·±æœ€å¥½çš„ç¦®ç‰©ã€‚",
  "ğŸŒˆ æ˜å¤©çš„ä½ ï¼Œæœƒæ„Ÿè¬ä»Šæ™šå¥½å¥½ä¼‘æ¯çš„è‡ªå·±ã€‚",
  "ğŸŒ» å³ä½¿ä»Šå¤©å¾ˆç´¯ï¼Œä¹Ÿè«‹è¨˜å¾—ä½ å·²ç¶“å¾ˆåŠªåŠ›äº†ã€‚",
  "ğŸŒ™ æœˆäº®ä¸æœƒå‚¬ä½ å…¥ç¡ï¼Œä½†å¥¹ä¸€ç›´åœ¨å®ˆè­·ä½ ã€‚",
  "ğŸª ç¡å‰æ”¾ä¸‹æ‰€æœ‰è§’è‰²ï¼Œä½ åªéœ€è¦åšè‡ªå·±ã€‚",
  "ğŸŒŒ å¤¢å¢ƒæ˜¯å¿ƒéˆçš„èªè¨€ï¼Œè«‹æº«æŸ”å‚¾è½å®ƒã€‚",
  "ğŸ§­ è¿·è·¯ä¹Ÿæ²’é—œä¿‚ï¼Œæ˜Ÿæ˜ŸæœƒæŒ‡å¼•æ–¹å‘ã€‚",
  "ğŸ«§ å‘¼å¸ã€æ”¾é¬†ã€æ²‰å…¥å¤œçš„æ‡·æŠ±ã€‚",
  "ğŸ¦¢ å®‰éœçš„å¤œæ™šï¼Œæ˜¯å¿ƒéˆæœ€å¥½çš„ç™‚ç™’å¸«ã€‚",
  "ğŸŒ¸ ç¡çœ ä¸æ˜¯é€ƒé¿ï¼Œè€Œæ˜¯é‡ç”Ÿçš„å…¥å£ã€‚",
  "ğŸªº ä½ çš„å°å®‡å®™ï¼Œä»Šæ™šä¹Ÿå€¼å¾—è¢«å¥½å¥½ç…§é¡§ã€‚",
  "ğŸŒƒ é»‘å¤œä¸ä»£è¡¨çµæŸï¼Œå®ƒæ˜¯å¦ä¸€ç¨®é–‹å§‹ã€‚",
  "ğŸ§¶ æ¯ä¸€å ´å¤¢ï¼Œéƒ½æ˜¯ä½ å¿ƒä¸­æœªèªªå®Œçš„æ•…äº‹ã€‚",
  "ğŸ«– æ”¾ä¸‹ç„¦æ…®ï¼Œæ³¡ä¸€å£ºå®‰å¿ƒçš„å¤¢çµ¦è‡ªå·±ã€‚"
];

function showRandomQuote() {
  const quote = quotes[Math.floor(Math.random() * quotes.length)];
  document.getElementById("quoteDisplay").textContent = quote;
}

window.onload = () => {
  showRandomQuote();
  setInterval(showRandomQuote, 10000); // æ¯ 10 ç§’æ›ä¸€å¥
  saveRecords();
};
</script>
</body>

</html>
